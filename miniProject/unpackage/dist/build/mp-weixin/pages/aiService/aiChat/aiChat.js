"use strict";const e=require("../../../common/vendor.js"),n=require("../../../common/assets.js"),t=require("../../../utils/userStorage.js"),a=require("../../../uni_modules/wot-design-uni/components/wd-toast/index.js");if(require("../../../uni_modules/wot-design-uni/locale/index.js"),!Array){(e.resolveComponent("wd-navbar")+e.resolveComponent("wd-icon")+e.resolveComponent("wd-toast"))()}Math||((()=>"../../../uni_modules/wot-design-uni/components/wd-navbar/wd-navbar.js")+(()=>"../../../uni_modules/wot-design-uni/components/wd-icon/wd-icon.js")+(()=>"../../../uni_modules/wot-design-uni/components/wd-toast/wd-toast.js"))();const o=e.defineComponent({__name:"aiChat",setup(o){a.useToast();const s=e=>'<div class="markdown-content">'+e.replace(/```([\s\S]*?)```/g,'<div class="pre-block"><div class="code-inline">$1</div></div>').replace(/`([^`]+)`/g,'<span class="code-inline">$1</span>').replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<span class="md-link" data-href="$2">$1</span>').replace(/\n\n/g,'</div><div class="text-block">').replace(/^\n?(.+)/,'<div class="text-block">$1').replace(/(.+)\n?$/,"$1</div>")+"</div>",r=e.ref(0),l=e.ref([]),i=e.ref(""),c=e.ref(0),u=e.ref(!1),d=e.ref(1),v=e.ref(null);e.ref("");const p=e.ref(""),g=e.computed((()=>{const e=l.value.length;return e?"msg-"+(e-1):""})),m=()=>{e.index.navigateBack()},f=e=>{c.value=e.detail.height||0},h=()=>{c.value=0},w=()=>{e.nextTick$1((()=>{const n=e.index.createSelectorQuery();n.select(".chat-container").boundingClientRect(),n.select(".messages-list").boundingClientRect(),n.exec((([e,n])=>{e&&n&&(r.value=n.height-e.height)}))}))};e.onLoad((()=>{const n=t.getUserInfo();console.log(n),null!=n?v.value=null==n?void 0:n.id:(e.index.showToast({title:"请先登录",icon:"none"}),setTimeout((()=>{e.index.reLaunch({url:"/pages/login/login"})}),1e3))}));const x=async()=>{var n;if(!i.value.trim()||u.value)return;const t=i.value.trim();l.value.push({role:"user",content:t}),i.value="",w(),u.value=!0,p.value="";try{l.value.push({role:"assistant",content:"",isTyping:!0});let n="";e.index.request({url:`https://campus.fybreeze.cn/api/ai/${d.value}/streamChat?clientId=${v.value}&message=${encodeURIComponent(t)}`,method:"GET",header:{Accept:"text/event-stream","sa-Token":e.index.getStorageSync("token")},enableChunked:!0,responseType:"arraybuffer",success:e=>{console.log("发送完成：",e)},onChunkReceived:e=>{}}).onChunkReceived((t=>{let a=(e=>{if("string"==typeof e)return e;for(var n=new DataView(e),t=new Uint8Array(e.byteLength),a=0;a<t.length;a++)t[a]=n.getUint8(a);var o="",s=t;for(a=0;a<s.length;a++)if(s[a]){var r=s[a].toString(2),l=r.match(/^1+?(?=0)/);if(l&&8==r.length){for(var i=l[0].length,c=s[a].toString(2).slice(7-i),u=1;u<i;u++)s[u+a]&&(c+=s[u+a].toString(2).slice(2));o+=String.fromCharCode(parseInt(c,2)),a+=i-1}else o+=String.fromCharCode(s[a])}return o})(t.data);for(p.value+=a;;){const t=p.value.indexOf("\n");if(-1===t)break;const a=p.value.substring(0,t).trim();if(p.value=p.value.substring(t+1),a.startsWith("data:")){const t=a.substring(5).trim();if(t){n+=t;const a=l.value[l.value.length-1];if(a&&"assistant"===a.role){a.content=n;try{a.parsedContent=s(n)}catch(o){console.error("Markdown解析失败:",o),a.parsedContent=n}e.nextTick$1((()=>{w()}))}}}}}))}catch(a){console.error("发送消息失败:",a),(null==(n=l.value[l.value.length-1])?void 0:n.isTyping)&&l.value.pop(),e.index.showToast({title:"发送失败，请重试",icon:"none"})}finally{u.value=!1;const e=l.value[l.value.length-1];e&&(e.isTyping=!1),w()}},C=()=>{};return(t,a)=>e.e({a:e.o(m),b:e.p({title:"DeepSeek","left-arrow":!0,fixed:!0,placeholder:!0,safeAreaInsetTop:!0}),c:0===l.value.length},0===l.value.length?{d:n._imports_0$7}:e.e({e:e.f(l.value,((t,a,o)=>e.e({a:"assistant"===t.role},"assistant"===t.role?{b:n._imports_0$7}:{},{c:"assistant"===t.role},"assistant"===t.role?{d:t.parsedContent||t.content}:{e:e.t(t.content)},{f:t.isTyping?1:"",g:"assistant"===t.role&&!t.isTyping},"assistant"!==t.role||t.isTyping?{}:{h:"d2ca65df-1-"+o,i:e.p({name:"copy",size:"16px",color:"#999"}),j:"d2ca65df-2-"+o,k:e.p({name:"refresh",size:"16px",color:"#999"}),l:"d2ca65df-3-"+o,m:e.p({name:"thumb-up",size:"16px",color:"#999"}),n:"d2ca65df-4-"+o,o:e.p({name:"thumb-down",size:"16px",color:"#999"})},{p:a,q:"msg-"+a,r:e.n(t.role)}))),f:u.value},u.value?{g:n._imports_0$7}:{}),{h:r.value,i:e.o(C),j:g.value,k:-1,l:u.value,m:e.o(f),n:e.o(h),o:e.o(x),p:i.value,q:e.o((e=>i.value=e.detail.value)),r:e.p({name:"arrow-up",size:"20px",color:i.value.trim()&&!u.value?"#FFFFFF":"#CCCCCC"}),s:i.value.trim()&&!u.value?1:"",t:e.o((e=>i.value.trim()&&!u.value&&x())),v:c.value+"px"})}}),s=e._export_sfc(o,[["__scopeId","data-v-d2ca65df"]]);wx.createPage(s);
