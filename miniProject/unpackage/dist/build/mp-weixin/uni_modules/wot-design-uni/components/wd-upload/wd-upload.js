"use strict";const e=require("../../../../common/vendor.js"),o=require("../common/util.js"),i=require("./utils.js"),s=require("../composables/useTranslate.js"),t=require("./types.js");Math||(a+r+n)();const a=()=>"../wd-icon/wd-icon.js",n=()=>"../wd-video-preview/wd-video-preview.js",r=()=>"../wd-loading/wd-loading.js",l=e.defineComponent({name:"wd-upload",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:t.uploadProps,emits:["fail","change","success","progress","oversize","chooseerror","remove","update:fileList"],setup(t,{expose:a,emit:n}){const r=t,l=n;a({submit:()=>w()});const{translate:u}=s.useTranslate("upload"),c=e.ref([]),d=e.computed((()=>!r.limit||c.value.length<r.limit)),f=e.ref();function m(){l("update:fileList",c.value)}e.watch((()=>r.fileList),(e=>{const{statusKey:i}=r;if(o.isEqual(e,c.value))return;const s=e.map((e=>(e[i]=e[i]||"success",e.response=e.response||"",{...e,uid:o.context.id++})));c.value=s}),{deep:!0,immediate:!0}),e.watch((()=>r.limit),(e=>{e&&e<c.value.length&&console.error("[wot-design]Error: props limit must less than fileList.length")}),{deep:!0,immediate:!0}),e.watch((()=>r.beforePreview),(e=>{e&&!o.isFunction(e)&&console.error("The type of beforePreview must be Function")}),{deep:!0,immediate:!0}),e.watch((()=>r.onPreviewFail),(e=>{e&&!o.isFunction(e)&&console.error("The type of onPreviewFail must be Function")}),{deep:!0,immediate:!0}),e.watch((()=>r.beforeRemove),(e=>{e&&!o.isFunction(e)&&console.error("The type of beforeRemove must be Function")}),{deep:!0,immediate:!0}),e.watch((()=>r.beforeUpload),(e=>{e&&!o.isFunction(e)&&console.error("The type of beforeUpload must be Function")}),{deep:!0,immediate:!0}),e.watch((()=>r.beforeChoose),(e=>{e&&!o.isFunction(e)&&console.error("The type of beforeChoose must be Function")}),{deep:!0,immediate:!0}),e.watch((()=>r.buildFormData),(e=>{e&&!o.isFunction(e)&&console.error("The type of buildFormData must be Function")}),{deep:!0,immediate:!0});const p=(i,s,t)=>{const{statusKey:a,uploadMethod:n}=r;i[a]="loading",o.isFunction(n)?n(i,s,t):((o,i,s)=>{e.index.uploadFile({url:s.action,header:s.header,name:s.name,fileName:s.name,fileType:s.fileType,formData:i,filePath:o.url,success(e){e.statusCode===s.statusCode?s.onSuccess(e,o,i):s.onError({...e,errMsg:e.errMsg||""},o,i)},fail(e){s.onError(e,o,i)}}).onProgressUpdate((e=>{s.onProgress(e,o)}))})(i,s,t)};function v(o){return new Promise(((i,s)=>{e.index.getImageInfo({src:o,success:e=>{i(e)},fail:e=>{s(e)}})}))}function h(e,i){const{statusKey:s}=r,t={uid:o.context.id++,name:e.name||"",thumb:e.thumb||"",[s]:"pending",size:e.size||0,url:e.path,percent:0};"number"==typeof i?c.value.splice(i,1,t):c.value.push(t),r.autoUpload&&w()}function w(){const{buildFormData:e,formData:i={},statusKey:s}=r,{action:t,name:a,header:n={},accept:l,successStatus:u}=r,d=o.isDef(u)?u:200;for(const o of c.value)"pending"==o[s]&&(e?e({file:o,formData:i,resolve:e=>{e&&p(o,e,{onSuccess:b,onError:g,onProgress:y,action:t,header:n,name:a,fileName:a,fileType:l,statusCode:d})}}):p(o,i,{onSuccess:b,onError:g,onProgress:y,action:t,header:n,name:a,fileName:a,fileType:l,statusCode:d}))}function g(e,o,i){const{statusKey:s}=r,t=c.value.findIndex((e=>e.uid===o.uid));t>-1&&(c.value[t][s]="fail",c.value[t].error=e.message,c.value[t].response=e,l("fail",{error:e,file:o,formData:i}),m())}function b(e,o,i){const{statusKey:s}=r,t=c.value.findIndex((e=>e.uid===o.uid));t>-1&&(c.value[t][s]="success",c.value[t].response=e.data,l("change",{fileList:c.value}),l("success",{file:o,fileList:c.value,formData:i}),m())}function y(e,o){const i=c.value.findIndex((e=>e.uid===o.uid));i>-1&&(c.value[i].percent=e.progress,l("progress",{response:e,file:o}))}function x(e){const{multiple:o,maxSize:s,accept:t,sizeType:a,limit:n,sourceType:u,compressed:d,maxDuration:f,camera:m,beforeUpload:p}=r;i.chooseFile({multiple:o,sizeType:a,sourceType:u,maxCount:n?n-c.value.length:9,accept:t,compressed:d,maxDuration:f,camera:m}).then((i=>{let t=i;o||(t=t.slice(0,1));const a=async o=>{for(let i=0;i<o.length;i++){const t=o[i];if("image"===t.type&&!t.size){const e=await v(t.path);t.size=e.width*e.height}Number(t.size)<=s?h(t,e):l("oversize",{file:t})}};p?p({files:t,fileList:c.value,resolve:e=>{e&&a(t)}}):a(t)})).catch((e=>{l("chooseerror",{error:e})}))}function F(e){if(r.disabled)return;const{beforeChoose:o}=r;o?o({fileList:c.value,resolve:o=>{o&&x(e)}}):x(e)}function L(e){c.value.splice(c.value.findIndex((o=>o.uid===e.uid)),1),l("change",{fileList:c.value}),l("remove",{file:e}),m()}function C(o){e.index.openDocument({filePath:o.url,showMenu:!0})}function P(o,i){const{onPreviewFail:s}=r;e.index.previewImage({urls:i,current:i[o],fail(){s?s({index:o,imgList:i}):e.index.showToast({title:"预览图片失败",icon:"none"})}})}function T(o,i){const{onPreviewFail:s}=r;e.index.previewMedia({current:o,sources:i.map((e=>({url:e.url,type:"video",poster:e.thumb}))),fail(){s?s({index:o,imgList:[]}):e.index.showToast({title:"预览视频失败",icon:"none"})}})}function I(e){const{beforePreview:i,reupload:s}=r,t=o.deepClone(c.value),a=t.findIndex((o=>o.url===e.url)),n=t.filter((e=>K(e))),l=n.findIndex((o=>o.url===e.url));s?F(a):i?i({file:e,index:a,imgList:[],fileList:t,resolve:e=>{e&&T(l,n)}}):T(l,n)}function K(e){return e.name&&o.isVideoUrl(e.name)||o.isVideoUrl(e.url)}function _(e){return e.name&&o.isImageUrl(e.name)||o.isImageUrl(e.url)}return(i,s)=>e.e({a:e.f(c.value,((s,t,a)=>e.e({a:_(s)},_(s)?{b:s.url,c:i.imageMode,d:e.o((e=>function(e){const{beforePreview:i,reupload:s}=r,t=o.deepClone(c.value),a=t.findIndex((o=>o.url===e.url)),n=t.filter((e=>_(e))).map((e=>e.url)),l=n.findIndex((o=>o===e.url));s?F(a):i?i({file:e,index:a,fileList:t,imgList:n,resolve:e=>{e&&P(l,n)}}):P(l,n)}(s)),t)}:K(s)?e.e({f:s.thumb},s.thumb?{g:s.thumb,h:i.imageMode,i:"fa8f5dac-0-"+a,j:e.p({name:"play-circle-filled","custom-class":"wd-upload__video-paly"}),k:e.o((e=>I(s)),t)}:{l:s.url,m:s.name||"视频"+t,n:s.thumb,o:"fa8f5dac-1-"+a,p:e.p({name:"play-circle-filled","custom-class":"wd-upload__video-paly"}),q:e.o((e=>I(s)),t)}):{r:"fa8f5dac-2-"+a,s:e.p({name:"file","custom-class":"wd-upload__file-icon"}),t:e.t(s.name||s.url),v:e.o((e=>function(e){const{beforePreview:i,reupload:s}=r,t=o.deepClone(c.value),a=t.findIndex((o=>o.url===e.url));s?F(a):i?i({file:e,index:a,imgList:[],fileList:t,resolve:o=>{o&&C(e)}}):C(e)}(s)),t)},{e:K(s),w:"success"!==s[r.statusKey]},"success"!==s[r.statusKey]?e.e({x:"loading"===s[r.statusKey]},"loading"===s[r.statusKey]?{y:"fa8f5dac-3-"+a,z:e.p({type:i.loadingType,size:i.loadingSize,color:i.loadingColor}),A:e.t(s.percent)}:{},{B:"fail"===s[r.statusKey]},"fail"===s[r.statusKey]?{C:"fa8f5dac-4-"+a,D:e.p({name:"close-outline","custom-class":"wd-upload__icon"}),E:e.t(s.error||e.unref(u)("error"))}:{}):{},{F:"loading"!==s[r.statusKey]&&!i.disabled},"loading"===s[r.statusKey]||i.disabled?{}:{G:e.o((e=>function(e){const{beforeRemove:o}=r,i=e,s=c.value[i];o?o({file:s,index:i,fileList:c.value,resolve:e=>{e&&L(s)}}):L(s)}(t)),t),H:"fa8f5dac-5-"+a,I:e.p({name:"error-fill","custom-class":"wd-upload__close"})},i.$slots["preview-cover"]?{J:"preview-cover-"+a,K:e.r("preview-cover",{file:s,index:t},a)}:{},{L:t}))),b:i.$slots["preview-cover"],c:e.n(i.customPreviewClass),d:d.value},d.value?e.e({e:i.$slots.default},i.$slots.default?{f:e.n(i.customEvokeClass),g:e.o(F)}:e.e({h:e.p({name:"fill-camera"}),i:i.limit&&i.showLimitNum},i.limit&&i.showLimitNum?{j:e.t(c.value.length),k:e.t(i.limit)}:{},{l:e.o(F),m:e.n(i.disabled?"is-disabled":""),n:e.n(i.customEvokeClass)})):{},{o:e.n(i.customClass),p:e.s(i.customStyle),q:e.sr(f,"fa8f5dac-7",{k:"videoPreview"})})}}),u=e._export_sfc(l,[["__scopeId","data-v-fa8f5dac"]]);wx.createComponent(u);
