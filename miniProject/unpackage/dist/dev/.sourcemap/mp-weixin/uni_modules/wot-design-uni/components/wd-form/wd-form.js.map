{"version":3,"file":"wd-form.js","sources":["uni_modules/wot-design-uni/components/wd-form/wd-form.vue","D:/HBuilderX/HBuilderX.3.1.22.20210709.full/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/RzovQ29kZS9jYW1wdXMvbWluaVByb2plY3QvdW5pX21vZHVsZXMvd290LWRlc2lnbi11bmkvY29tcG9uZW50cy93ZC1mb3JtL3dkLWZvcm0udnVl"],"sourcesContent":["<template>\n  <view :class=\"`wd-form ${customClass}`\" :style=\"customStyle\">\n    <slot></slot>\n    <wd-toast v-if=\"props.errorType === 'toast'\" selector=\"wd-form-toast\" />\n  </view>\n</template>\n\n<script lang=\"ts\">\nexport default {\n  name: 'wd-form',\n  options: {\n    addGlobalClass: true,\n    virtualHost: true,\n    styleIsolation: 'shared'\n  }\n}\n</script>\n\n<script lang=\"ts\" setup>\nimport wdToast from '../wd-toast/wd-toast.vue'\nimport { reactive, watch } from 'vue'\nimport { deepClone, getPropByPath, isArray, isDef, isPromise, isString } from '../common/util'\nimport { useChildren } from '../composables/useChildren'\nimport { useToast } from '../wd-toast'\nimport { type FormRules, FORM_KEY, type ErrorMessage, formProps, type FormExpose } from './types'\n\nconst { show: showToast } = useToast('wd-form-toast')\nconst props = defineProps(formProps)\n\nconst { children, linkChildren } = useChildren(FORM_KEY)\nlet errorMessages = reactive<Record<string, string>>({})\n\nlinkChildren({ props, errorMessages })\n\nwatch(\n  () => props.model,\n  () => {\n    if (props.resetOnChange) {\n      clearMessage()\n    }\n  },\n  { immediate: true, deep: true }\n)\n\n/**\n * 表单校验\n * @param prop 指定校验字段或字段数组\n */\nasync function validate(prop?: string | string[]): Promise<{ valid: boolean; errors: ErrorMessage[] }> {\n  const errors: ErrorMessage[] = []\n  let valid: boolean = true\n  const promises: Promise<void>[] = []\n  const formRules: FormRules = getMergeRules()\n  const propsToValidate = isArray(prop) ? prop : isDef(prop) ? [prop] : []\n  const rulesToValidate: FormRules =\n    propsToValidate.length > 0\n      ? propsToValidate.reduce((acc, key) => {\n          if (formRules[key]) {\n            acc[key] = formRules[key]\n          }\n          return acc\n        }, {} as FormRules)\n      : formRules\n\n  for (const propName in rulesToValidate) {\n    const rules = rulesToValidate[propName]\n    const value = getPropByPath(props.model, propName)\n\n    if (rules && rules.length > 0) {\n      for (const rule of rules) {\n        if (rule.required && (!isDef(value) || value === '')) {\n          errors.push({\n            prop: propName,\n            message: rule.message\n          })\n          valid = false\n          break\n        }\n        if (rule.pattern && !rule.pattern.test(value)) {\n          errors.push({\n            prop: propName,\n            message: rule.message\n          })\n          valid = false\n          break\n        }\n        const { validator, ...ruleWithoutValidator } = rule\n        if (validator) {\n          const result = validator(value, ruleWithoutValidator)\n          if (isPromise(result)) {\n            promises.push(\n              result\n                .then((res) => {\n                  if (typeof res === 'string') {\n                    errors.push({\n                      prop: propName,\n                      message: res\n                    })\n                    valid = false\n                  } else if (typeof res === 'boolean' && !res) {\n                    errors.push({\n                      prop: propName,\n                      message: rule.message\n                    })\n                    valid = false\n                  }\n                })\n                .catch((error?: string | Error) => {\n                  const message = isDef(error) ? (isString(error) ? error : error.message || rule.message) : rule.message\n                  errors.push({ prop: propName, message })\n                  valid = false\n                })\n            )\n          } else {\n            if (!result) {\n              errors.push({\n                prop: propName,\n                message: rule.message\n              })\n              valid = false\n            }\n          }\n        }\n      }\n    }\n  }\n\n  await Promise.all(promises)\n\n  showMessage(errors)\n\n  if (valid) {\n    if (propsToValidate.length) {\n      propsToValidate.forEach(clearMessage)\n    } else {\n      clearMessage()\n    }\n  }\n\n  return {\n    valid,\n    errors\n  }\n}\n\n// 合并子组件的rules到父组件的rules\nfunction getMergeRules() {\n  const mergedRules: FormRules = deepClone(props.rules)\n  const childrenProps = children.map((child) => child.prop)\n\n  // 过滤掉在 children 中不存在对应子组件的规则\n  Object.keys(mergedRules).forEach((key) => {\n    if (!childrenProps.includes(key)) {\n      delete mergedRules[key]\n    }\n  })\n\n  children.forEach((item) => {\n    if (isDef(item.prop) && isDef(item.rules) && item.rules.length) {\n      if (mergedRules[item.prop]) {\n        mergedRules[item.prop] = [...mergedRules[item.prop], ...item.rules]\n      } else {\n        mergedRules[item.prop] = item.rules\n      }\n    }\n  })\n  return mergedRules\n}\n\nfunction showMessage(errors: ErrorMessage[]) {\n  const childrenProps = children.map((e) => e.prop).filter(Boolean)\n  const messages = errors.filter((error) => error.message && childrenProps.includes(error.prop))\n  if (messages.length) {\n    messages.sort((a, b) => {\n      return childrenProps.indexOf(a.prop) - childrenProps.indexOf(b.prop)\n    })\n    if (props.errorType === 'toast') {\n      showToast(messages[0].message)\n    } else if (props.errorType === 'message') {\n      messages.forEach((error) => {\n        errorMessages[error.prop] = error.message\n      })\n    }\n  }\n}\n\nfunction clearMessage(prop?: string) {\n  if (prop) {\n    errorMessages[prop] = ''\n  } else {\n    Object.keys(errorMessages).forEach((key) => {\n      errorMessages[key] = ''\n    })\n  }\n}\n\n/**\n * 重置表单项的验证提示\n */\nfunction reset() {\n  clearMessage()\n}\n\ndefineExpose<FormExpose>({ validate, reset })\n</script>\n\n<style lang=\"scss\" scoped>\n@import './index.scss';\n</style>\n","import Component from 'G:/Code/campus/miniProject/uni_modules/wot-design-uni/components/wd-form/wd-form.vue'\nwx.createComponent(Component)"],"names":["useToast","useChildren","FORM_KEY","reactive","watch","isArray","isDef","getPropByPath","isPromise","isString","deepClone"],"mappings":"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"}